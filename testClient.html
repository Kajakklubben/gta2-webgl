<html>
<head>
<title>Gta2 web port</title>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
<style>
    body {
        font-family: Monospace;
        background-color: #f0f0f0;
        margin: 0px;
        overflow: hidden;
    }
</style>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="/jdataview.js" type="application/javascript" language="javascript">
</script>
<script src="/mapParser.js" type="application/javascript" language="javascript">
</script>
<script src="/styleParser.js" type="application/javascript" language="javascript">
</script>
<script src="/three/build/three.min.js"></script>

<script src="/three/examples/js/libs/stats.min.js"></script>
<script src="/render.js"></script>


<script>

function getXHR(){
    var xhr;
    try{
        xhr = new XMLHttpRequest();
    }catch(e){
        try{
            xhr = new ActiveXObject("MSXML2.XMLHTTP.6.0");
        }catch(e2){
            try{
                xhr = new ActiveXObject("MSXML2.XMLHTTP");
            }catch(e3){}
        }
    }
    return xhr;
}

function getBinaryData(url, callback){
    var xhr = getXHR();
    xhr.open("GET", url, !!callback);
    if(callback){
        xhr.onload = function(){callback(xhr, true)};
        xhr.onerror = function(){callback(xhr, false)};
    }
    xhr.send();

	if(typeof callback == "function"){
		return  undefined;
	} else {
		return xhr.responseText;
	}
}
</script>

</head>

<body>
<script>
	var level;
	var style;
	var style = new Object();
	style.tiles = new Array();
	style.tiles[0] = new Image();
	
	var dummyTexture = new Image();
	
	dummyTexture.onload = function () {
	
		var loadTextures = true;
	
		if(!loadTextures) {
			for(i = 0;i < 1024;i++) {
				style.tiles[i] = dummyTexture;
			}
		}
	
		$(function () {
			$("#statusmessage").text("Downloading map...");
			$("#progressbarContent").css("width", "10%");		
			
			getBinaryData("http://localhost:8000/MP1-comp.gmp", LoadComplete);
			
			function LoadComplete(data, err)
			{
				
				$("#statusmessage").text("Parsing map...");
				$("#progressbarContent").css("width", "20%");
			
				var mapData = data.responseText;
				level = new ReadFromData(mapData);
				
				$("#statusmessage").text("Downloading styles...");
				$("#progressbarContent").css("width", "50%");
				
				getBinaryData("http://localhost:8000/bil.sty", StyleLoadComplete);
			}
			
			function StyleLoadComplete(data, err) {
				var styleData = data.responseText;
				
				
				$("#statusmessage").text("Parsing styles...");
				$("#progressbarContent").css("width", "70%");
				
				if(loadTextures) {
					style = ParseStyle(styleData, level);
				}
				
				$("#statusmessage").text("Initalizing game...");
				$("#progressbarContent").css("width", "90%");
		
				init();
					
				$("#loadingScreen").hide();
				animate();
				/*for (var i = 20; i < 250; i++)
				{	
					for (var j = 20; j < 250; j++)
					{		
						for (var k = 3; k < 4; k++)
						{
							var block = level.map[i][j][k];
				
							if(block != undefined && block.Lid != undefined && block.Lid.tileNumber != undefined)
							{ 
								debugger;
								document.body.appendChild(style.tiles[block.Lid.tileNumber]);
							}
						}
					}
				}*/
			}
		});
		
	};
	
	dummyTexture.src = "http://localhost:8000/texture.jpg";
	
</script>

<div id="loadingScreen" style="position:absolute; width:100%; height:100%">
	<div id="statusmessage" style="position: absolute; top: 10%; width: 100%; text-align: center;"></div>
	<div id="progressbar" style="width: 250px; border: 1px solid #bbb; height:20px; margin:0 auto; margin-top:150px">
		<div id="progressbarContent" style="position:relative; height:100%; background:#ccc; width:0%"></div>
</div>

</div>
</body>

</html>